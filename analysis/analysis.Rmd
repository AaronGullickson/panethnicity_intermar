---
title: "Analysis for Project"
output: 
  html_document: 
    fig_height: 6
    fig_width: 9
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(here)
source(here("analysis","check_packages.R"))
source(here("analysis","useful_functions.R"))
load(here("analysis","output","models.RData"))
load(here("analysis","output","alternates.RData"))

my_palette <- c("#7b3294","#008837","#a6dba0")
```


```{r create-coef-table}
#extract coefficient values from model summary as tibble
get_coefs <- function(x) {
  temp <- coef(x)[,c(1,3)]
  return(tibble(variable=rownames(temp), coef=temp[,1], se=temp[,2]))
}
#bind together the model summaries
bind_models <- function(models_summary) {
  temp <- lapply(models_summary, get_coefs) %>%
    bind_rows(.id="model") %>%
    filter(grepl("race_exog", variable))
  return(temp)
}

## Pentagon Models ##
coefs_pent <- list(census=models_census_pentagon,
                    acs_1980basis=models_acs1980_pentagon,
                    acs_full=models_acsfull_pentagon) %>%
  lapply(bind_models) %>%
  bind_rows(.id="data") %>%
  mutate(variable=convert_intermar_names(variable, "race_exog_pent"),
         model=factor(model,
                      levels=c("base","bendog","lendog","both"),
                      labels=c("Baseline", "+ birthplace endogamy",
                               "+ language endogamy", "+ both")),
         data=factor(data,
                     levels=c("census","acs_1980basis","acs_full"),
                     labels=c("Census 1980", 
                              "ACS 2014-18, 1980 ethnic groups",
                              "ACS 2014-18, all ethnic groups"))) %>%
  order_variables("Census 1980", "+ both")

#create a dataset that can be used for the arrows in the graph
#need a reworked dataset for arrows
arrows_pent <- coefs_pent %>%
  filter(model=="+ both" & 
           variable!="South Asian ethnic exogamy" &
           data!="ACS 2014-18, all ethnic groups") %>%
  select(variable, coef, data) %>% 
  pivot_wider(names_from=data, values_from=coef) %>%
  rename(coef.census=`Census 1980`, 
         coef.acs=`ACS 2014-18, 1980 ethnic groups`) %>%
  filter(abs(exp(coef.census)-exp(coef.acs))>0.05)

## Extended Models ##
coefs_extended <- list(census=models_census_extended,
                       acs_1980basis=models_acs1980_extended,
                       acs_full=models_acsres_extended) %>%
  lapply(bind_models) %>%
  bind_rows(.id="data") %>%
  mutate(variable=convert_intermar_names(variable, "race_exog_extended"),
         model=factor(model,
                      levels=c("base","bendog","lendog","both"),
                      labels=c("Baseline", "+ birthplace endogamy",
                               "+ language endogamy", "+ both")),
         data=factor(data,
                     levels=c("census","acs_1980basis","acs_full"),
                     labels=c("Census 1980", 
                              "ACS 2014-18, 1980 ethnic groups",
                              "ACS 2014-18, expanded ethnic groups"))) %>%
  order_variables("Census 1980", "+ both")

#arrows
arrows_extended <- coefs_extended %>%
  filter(model=="+ both" & 
           variable!="South Asian ethnic exogamy" &
           data!="ACS 2014-18, expanded ethnic groups") %>%
  select(variable, coef, data) %>% 
  pivot_wider(names_from=data, values_from=coef) %>%
  rename(coef.census=`Census 1980`, 
         coef.acs=`ACS 2014-18, 1980 ethnic groups`) %>%
  filter(abs(exp(coef.census)-exp(coef.acs))>0.05)
```

## Analysis of Potential Partner Characteristics

### Language and Birthplace Heterogeneity

#### Language Heterogeneity

```{r ese-asian-language}
alternates_acs %>%
  filter(race %in% c("Chinese","Korean","Japanese","Vietnamese",
                     "Filipino","Cambodian","Hmong","Laotian",
                     "Thai","Burmese","Indonesian","Malaysian",
                     "Nepalese","Mongolian","Bhutanese")) %>%
  mutate(lang=factor(case_when(
    language==1 ~ "English",
    language==37 ~ "Other Altaic",
    language>=40 & language <=42 ~ "Dravidian",
    language==43 ~ "Chinese",
    language==44 ~ "Tibetan",
    language==45 ~ "Burmese, Lisu, Lolo",
    language==46 ~ "Kachin",
    language==47 ~ "Thai, Siamese, Lao",
    language==48 ~ "Japanese",
    language==49 ~ "Korean",
    language==50 ~ "Vietnamese",
    language==51 ~ "Other E&SE Language",
    language==52 ~ "Indonesian",
    language==53 ~ "Other Malayan",
    language==54 ~ "Filipino, Tagalog",
    TRUE ~ "Other Language"),
    levels=c("English","Chinese","Japanese","Korean","Vietnamese",
             "Filipino, Tagalog","Thai, Siamese, Lao","Tibetan",
             "Burmese, Lisu, Lolo","Indonesian","Other Malayan","Kachin",
             "Dravidian","Other Altaic","Other E&SE Language",
             "Other Language")),
    race=fct_reorder(race, lang=="English", mean)
  ) %>%
  select(race, lang, language) %>%
  droplevels() %>%
  ggplot(aes(x=race, fill=fct_rev(lang)))+
  geom_bar(position="fill")+
  scale_fill_manual(values = c("grey", brewer.pal(7, "Dark2"),
                               "tomato","sienna","orchid","royalblue","maroon",
                               "paleturquoise1","grey30"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL, y="cumulative percent",
       title="Language use among E&SE Asian ethnic groups",
       caption="Data Source: ACS 2014-18, partner alternates",
       fill="Primary language spoken")+
  coord_flip()+
  theme_bw()
```

Clearly this shows a lot of diversity in language among Asian ethnic groups. It also reveals that the general language codes may be a bit problematic for a few Asian groups. I probably need to think more carefully about the language variable I use to define language endogamy. I probably can use the detailed language codes, but I may need to look at particular cases that need collapsing. This will take some work. Also, what is up with Hmong being listed as Tibetan? I checked and that seems accurate in the data.

```{r south-asian-language}
alternates_acs %>%
  filter(race %in% c("Asian Indian","Bangladeshi",
                     "Pakistani","Sri Lankan")) %>%
  mutate(lang=factor(case_when(
    language==1 ~ "English",
    language>=40 & language <=42 ~ "Dravidian",
    language==31 ~ "Hindi and related",
    TRUE ~ "Other Language"),
    levels=c("English","Dravidian","Hindi and related","Other Language")),
    race=fct_reorder(race, lang=="English", mean)
  ) %>%
  select(race, lang, language) %>%
  droplevels() %>%
  ggplot(aes(x=race, fill=fct_rev(lang)))+
  geom_bar(position="fill")+
  scale_fill_manual(values = c("grey","royalblue","orchid","grey30"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL, y="cumulative percent",
       title="Language use among South Asian ethnic groups",
       caption="Data Source: ACS 2014-18, partner alternates",
       fill="Primary language spoken")+
  coord_flip()+
  theme_bw()
```

Mostly Hindi (and related) or Dravidian languages in South Asia, but I wonder if I need to go into more detail here for those language groups in languaged?

```{r ese-latino-language}
alternates_acs %>%
  filter(race %in% c("Mexican","Puerto Rican","Cuban","Costa Rican",
                     "Guatemalan","Honduran","Nicaraguan","Panamanian",
                     "Salvadorian","Argentinian","Bolivian","Chilean",
                     "Colombian","Ecuadorian","Paraguayan","Peruvian",
                     "Uruguayan","Venezuelan","Dominican")) %>%
  mutate(lang=factor(case_when(
    language==1 ~ "English",
    language==12 ~ "Spanish",
    TRUE ~ "Other Language"),
    levels=c("English","Spanish","Other Language")),
    race=fct_reorder(race, lang=="English", mean)
  ) %>%
  select(race, lang, language) %>%
  droplevels() %>%
  ggplot(aes(x=race, fill=fct_rev(lang)))+
  geom_bar(position="fill")+
  scale_fill_manual(values = c("grey", "tomato","grey30"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL, y="cumulative percent",
       title="Language use among Latino ethnic groups",
       caption="Data Source: ACS 2014-18, partner alternates",
       fill="Primary language spoken")+
  coord_flip()+
  theme_bw()
```

For Latinos, much less diversity. The only real diversity is given by the percentage of each group that speak English vs. Spanish.

#### Birthplace Heterogeneity

```{r ese-asian-birthplace}
alternates_acs %>%
  filter(race %in% c("Chinese","Korean","Japanese","Vietnamese",
                     "Filipino","Cambodian","Hmong","Laotian",
                     "Thai","Burmese","Indonesian","Malaysian",
                     "Nepalese","Mongolian","Bhutanese")) %>%
  mutate(birthplace=factor(case_when(
    bpld==1 ~ "USA",
    bpld==50000 ~ "China",
    bpld==50010 ~ "Hong Kong",
    bpld==50020 ~ "Macau",
    bpld==50030 ~ "Mongolia",
    bpld==50040 ~ "Taiwan",
    bpld==50100 ~ "Japan",
    bpld>=50200 & bpld<=50220 ~ "Korea",
    bpld==51100 ~ "Cambodia",
    bpld==51200 ~ "Indonesia",
    bpld==51300 ~ "Laos",
    bpld==51400 ~ "Malaysia",
    bpld==51500 ~ "Philippines",
    bpld==51600 ~ "Singapore",
    bpld==51700 ~ "Thailand",
    bpld==51800 ~ "Vietnam",
    bpld==52100 ~ "India",
    bpld==52110 ~ "Bangladesh",
    bpld==52120 ~ "Bhutan",
    bpld==52130 ~ "Myanmar",
    bpld==52400 ~ "Nepal",
    bpld==46500 ~ "Russia",
    TRUE ~ "Other Place"),
    levels=c("USA","China","Hong Kong","Macau","Taiwan","Japan","Korea",
             "Cambodia","Indonesia","Laos","Malaysia","Philippines",
             "Singapore","Thailand","Vietnam","India","Bangladesh","Bhutan",
             "Myanmar","Nepal","Mongolia","Russia","Other Place")),
    race=fct_reorder(race, birthplace=="USA", mean)
  ) %>%
  select(race, birthplace, bpld) %>%
  droplevels() %>%
  ggplot(aes(x=race, fill=fct_rev(birthplace)))+
  geom_bar(position="fill")+
  scale_fill_manual(values = c("grey", brewer.pal(7, "Dark2"),
                               "tomato","sienna","orchid","royalblue","maroon",
                               "paleturquoise1","olivedrab",
                               brewer.pal(6, "Set1"), "grey30"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL, y="cumulative percent",
       title="Birthplace among E&SE Asian ethnic groups",
       caption="Data Source: ACS 2014-18, partner alternates",
       fill="Place of Birth")+
  coord_flip()+
  theme_bw()
```

This looking much better using the detailed birthplace codes. Mongolia is still a bit of an issue, but if you look at the actual code its "Other Asia, NEC" so not much that can be done with it. 

In general, we see a lot of diversity here as one would expect. mostly the ethnic group corresponds pretty closely to a common birthplace, because of the implied nationality, but there are several cases where this is not true. 

```{r south-asian-birthplace}
alternates_acs %>%
  filter(race %in% c("Asian Indian","Bangladeshi",
                     "Pakistani","Sri Lankan")) %>%
  mutate(birthplace=factor(case_when(
    bpld==1 ~ "USA",
    bpld==52100 ~ "India",
    bpld==52110 ~ "Bangladesh",
    bpld==52140 ~ "Pakistan",
    bpld==52150 ~ "Sri Lanka",
    bpld==30040 ~ "Guyana",
    bpld==26060 ~ "Trinidad and Tobago",
    bpld>=41000 & bpld<=41300 ~ "United Kingdom",
    TRUE ~ "Other Place"),
    levels=c("USA","India","Bangladesh","Pakistan","Sri Lanka",
             "Guyana","Trinidad and Tobago","United Kingdom","Other Place")),
    race=fct_reorder(race, birthplace=="USA", mean)
  ) %>%
  select(race, birthplace, bpld) %>%
  droplevels() %>%
  ggplot(aes(x=race, fill=fct_rev(birthplace)))+
  geom_bar(position="fill")+
  scale_fill_manual(values = c("grey", brewer.pal(7, "Dark2"), "grey30"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL, y="cumulative percent",
       title="Birthplace among South Asian ethnic groups",
       caption="Data Source: ACS 2014-18, partner alternates",
       fill="Place of Birth")+
  coord_flip()+
  theme_bw()
```

Mostly it ties closely to nationality, with pretty similar percentages born in the US. The Asian Indian population is more diverse in birthplace than other groups, partly reflecting transnational migration in the British Empire, I suspect.

```{r ese-latino-birthplace}
alternates_acs %>%
  filter(race %in% c("Mexican","Puerto Rican","Cuban","Costa Rican",
                     "Guatemalan","Honduran","Nicaraguan","Panamanian",
                     "Salvadorian","Argentinian","Bolivian","Chilean",
                     "Colombian","Ecuadorian","Paraguayan","Peruvian",
                     "Uruguayan","Venezuelan","Dominican")) %>%
  mutate(birthplace=factor(case_when(
    bpld==1 ~ "USA",
    bpld==20000 ~ "Mexico",
    bpld==21020 ~ "Costa Rica",
    bpld==21030 ~ "El Salvador",
    bpld==21040 ~ "Guatemala",
    bpld==21050 ~ "Honduras",
    bpld==21060 ~ "Nicaragua",
    bpld==21070 ~ "Panama",
    bpld==30005 ~ "Argentina",
    bpld==30010 ~ "Bolivia",
    bpld==30020 ~ "Chile",
    bpld==30025 ~ "Colombia",
    bpld==30030 ~ "Ecuador",
    bpld==30045 ~ "Paraguay",
    bpld==30050 ~ "Peru",
    bpld==30060 ~ "Uruguay",
    bpld==30065 ~ "Venezuela",
    bpld==25000 ~ "Cuba",
    bpld==26010 ~ "Dominican Republic",
    bpld==11000 ~ "Puerto Rico",
    TRUE ~ "Other Place"),
    levels=c("USA","Mexico","Costa Rica","El Salvador","Guatemala","Honduras",
             "Nicaragua","Panama","Argentina","Bolivia","Chile",
             "Colombia","Ecuador","Paraguay","Peru","Uruguay","Venezuela",
             "Cuba","Dominican Republic","Puerto Rico","Other Place")),
    race=fct_reorder(race, birthplace=="USA", mean)
  ) %>%
  select(race, birthplace, bpld) %>%
  droplevels() %>%
  ggplot(aes(x=race, fill=fct_rev(birthplace)))+
  geom_bar(position="fill")+
  scale_fill_manual(values = c("grey", brewer.pal(7, "Dark2"),
                               "tomato","sienna","orchid","royalblue","maroon",
                               "paleturquoise1","olivedrab",
                               brewer.pal(5, "Set1"), "grey30"))+
  scale_y_continuous(labels = scales::percent)+
  labs(x=NULL, y="cumulative percent",
       title="Birthplace among E&SE Asian ethnic groups",
       caption="Data Source: ACS 2014-18, partner alternates",
       fill="Place of Birth")+
  coord_flip()+
  theme_bw()
```

### Race Reporting among Latinos

## Overall Ethnic Exogamy

I begin by looking at the models that estimate a single term for Asian, Latino, and South Asian ethnic exogamy. These terms estimate the (log) odds of an ethnically exogamous union in comparison to an endogamou union. I want to see how these estimates change over time and with controls for birthplace and language endogamy. To look at the effects of controls, I run four sets of models in each time period:

1. A baseline model that controls for the age difference between the spouses (and its square), educational crossing parameters, and hypogamy/hypergamy terms. 
2. A model that adds to the baseline model a control for language endogamy.
3. A model that adds to the baseline model a control for birthplace endogamy.
4. A model that adds to the baseline model both controls for language and birthplace endogamy.

These models are estimated on data that is restricted to the ethnic groups available in the Census 1980 data (Mexican, Cuban, Puerto Rican, Chinese, Japanese, Korean, Vietnamese, and Filipino). This allows for results that are directly comparable across time. However, I also want to see how these results change if I add in all of the possible Asian and Latino nationality groups in the later time period. This gives me 19 Latino groups and 15 Asian groups. Using this data, I also have three additional South Asian groups (Bangladeshi, Pakistani, and Sri Lankan) and so I can estimate an ethnic exogamy term for this group. 

### E&SE Asian Ethnic Exogamy
  
```{r asian-exog-lolly}
coefs_pent %>% 
  filter(variable=="E&SE Asian ethnic exogamy") %>%
  ggplot(aes(y=model, x=exp(coef), color=data))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_color_manual(values=c("#7b3294","#008837","#a6dba0"))+
  scale_x_continuous(limits=c(0,1))+
  labs(y=NULL, 
       x="Odds ratio of union formation for E&SE Asian ethnic intermarriage relative to ethnic endogamy",
       color="Data source",
       title="Odds ratio of E&SE Asian ethnic exogamy",
       subtitle="by year and data source")+
  theme_bw()+
  theme(legend.position = "right")
```

The results for Asian ethnic exogamy reveal that language and birthplace endogamy both play important roles. Without controlling for either one, the results show that Asian ethnic exogamy is moderate and has actually gone down a little over time. However, once we factor out language and birthplace endogamy, ethnic exogamy is quite common and has increased substantially over time. Language endogamy is more important than birthplace endogamy, but both play a role. 

Thus for Asian nationality groups, we actually observe relatively little pan-ethnicity in intermarriage, but that is because these groups are divided by language and birthplace diversity. In a counterfactual case in which most Asian Americans are all born in the US and speak English, we would see high level of ethnic exogamy.

If I expand the analysis in the later data to all Asian ethnic groups, the results are very similar, with slightly higher ethnic exogamy in each model. 

```{r asian-exog-compare-dot}
coefs_pent %>%
  filter(model=="+ both" & grepl("E&SE Asian",variable) 
         & !grepl("AIAN", variable)) %>%
  select(variable, coef, data) %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2, alpha=0.8)+
  geom_segment(data=subset(arrows_pent, grepl("E&SE Asian",variable) &
                             !grepl("AIAN", variable)), 
                aes(x=variable, xend=variable, 
                    y=exp(coef.census), yend=exp(coef.acs)),
                arrow = arrow(length = unit(0.02, "npc")),
                color="grey60")+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="E&SE Asian ethnic exogamy in comparison to E&SE Asian racial exogamy")+
  theme_bw()
```

The figure above shows the Asian ethnic exogamy term in comparison to the terms for Asian outmarriage with other racial groups. A few features stand out:

* Asian ethnic exogamy is more common than any form of racial exogamy and has increased over time.
* Asian/South Asian exogamy is much less common than overall Asian ethnic exogamy and has actually become slightly less common over time.
* Of the four interracial marriage possibilities here, Asian/White intermarriage has increased the most, but still is much less likely than Asian ethnic exogamy.
* Asian/Black intermarriage remains extremely rare and has hardly changed at all.

### Latino Ethnic Exogamy

```{r latino-exog-lolly}
coefs_pent %>%
  filter(variable=="Latino ethnic exogamy") %>%
  ggplot(aes(y=model, x=exp(coef), color=data))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_color_manual(values=my_palette)+
  scale_x_continuous(limits=c(0,1))+
  labs(y=NULL, 
       x="Odds ratio of union formation for Latino ethnic intermarriage relative to ethnic endogamy",
       color="Data source",
       title="Odds ratio of Latino ethnic exogamy",
       subtitle="by year and data source")+
  theme_bw()+
  theme(legend.position = "right")
```

For Latino ethnic exogamy we see a very different story. Using the three Latino groups available in Census 1980, there have not been significant increases in Latino ethnic exogamy over time. In fact, Latino ethnic exogamy has decreased slightly. Controlling for birthplace and language endogamy has relatively little effect on these patterns. Controlling for birthplace endogamy increases exogamy somewhat, as expected. Controlling for language endogamy by itself has very little effect on the model.

If we expand to the full 19 Latino groups in the ACS data, the patterns are generally the same, but there is greater Latino ethnic exogamy overall. We cannot really say if this is an increase because we don't have a comparison for 1980, but it does suggest that the particular groups of Mexicans, PRs and Cubans are somewhat less exogamous with each other than Latinos overall. 

```{r latino-exog-compare-dot}
coefs_pent %>%
  filter(model=="+ both" & grepl("Latino",variable) & 
           !grepl("AIAN",variable)) %>%
  select(variable, coef, data) %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2)+
  geom_segment(data=subset(arrows_pent, grepl("Latino",variable) &
                             !grepl("AIAN",variable)), 
                aes(x=variable, xend=variable, 
                    y=exp(coef.census), yend=exp(coef.acs)),
                arrow = arrow(length = unit(0.02, "npc")),
                color="grey60", alpha=0.6)+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="Latino ethnic exogamy in comparison to Latino racial exogamy")+
  theme_bw()
```

The figure above shows where Latino ethnic exogamy stands in relation to racial outmarriage among Latinos. The results here are somewhat different than the Asian case. Notably:

* There has been a large increase in the odds of intermarriage between Latinos and Whites and relatively little change in Latino ethnic exogamy. The consequence is that in the restricted group case, Latino/White intermarriage is slightly more likely than Latino ethnic exogamy in the current data. In the data with more ethnic groups, Latino ethnic exogamy is still slightly more common than Latino/White intermarriage, but just.
* Latino/Black intermarriage remains very rare but has increased substantially over time. This suggests somewhat weaker boundaries at this "black/non-black" divide for Latinos than for Asians. Some of this may be due to racial heterogeneity among Latinos (i.e. Afro-Latinos).
* The South Asian/Latino parameter has gone down significantly. This seems to be a general pattern for the South Asian term and may reflect measurement issues.

### South Asian Ethnic Exogamy

I can only look at South Asian ethnic exogamy in the ACS data with all ethnic groups, which has the groups of Asian Indian, Pakistani, Bangladeshi, and Sri Lankan. In all other cases, the only South Asian ethnic group is Asian Indians. 

```{r south-asian-exog-lolly}
coefs_pent %>%
  filter(variable=="South Asian ethnic exogamy") %>%
  ggplot(aes(y=model, x=exp(coef), color=data))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_color_manual(values=my_palette[3])+
  scale_x_continuous(limits=c(0,1))+
  labs(y=NULL, 
       x="Odds ratio of union formation for South Asian ethnic intermarriage relative to ethnic endogamy",
       color="Data source",
       title="Odds ratio of South Asian ethnic exogamy",
       subtitle="by year and data source")+
  theme_bw()+
  theme(legend.position = "right")
```

Language and birthplace endogamy both increase the estimate of ethnic exogamy. The odds of ethnic exogamy are more substantial than for Latinos but less than for E&SE Asians. Regarding language, I do worry a little about the Urdu/Hindi issue. This is probably the most common case of language "exogamy", but these are generally considered to be so similar as to be dialects. This may artificially inflate the estimates when controlling for language endogamy. TODO: do a sensitivity analysis where I treat Urdu/Hindi as language endogamous.

```{r south-asian-exog-compare-dot}
coefs_pent %>%
  filter(model=="+ both" & grepl("South Asian",variable) &
           !grepl("AIAN",variable)) %>%
  select(variable, coef, data) %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2, alpha=0.8)+
  geom_segment(data=subset(arrows_pent, grepl("South Asian",variable) &
           !grepl("AIAN",variable)), 
               aes(x=variable, xend=variable, 
                   y=exp(coef.census), yend=exp(coef.acs)),
               arrow = arrow(length = unit(0.02, "npc")),
               color="grey60")+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="South Asian ethnic exogamy in comparison to South Asian racial exogamy")+
  theme_bw()
```

The figure above looks at South Asian racial exogamy. I also include ethnic exogamy here for comparative purposes with the same dataset, but I cannot look at it over time due to the lack of comparable data across time.

The results show little difference in the ACS data with using only Asian Indians and using all four groups. In all cases, South Asian racial intermarriage has become *less* likely over time. The smallest drops are for Asian/South Asian which may reflect some form of pan-ethnicity I guess and South Asian/Black, but the latter case was close to zero already. 

I do worry that these drops are driven by measurement issues. The Census lists "Asian Indian" as a category to help distinguish it from the case where people are looking for an American Indian category. My guess would be that people have gotten better over time at not mis-checking this box when they meant to select an American Indian category. Those mischeckers are probably more likely to intermarry with other groups given the historical legacy of the American Indian group. Thus, the later period may be witnessing a drop simply because it is more accurately capturing people who intended to check Asian Indian. In support of this hypothesis, the odds of intermarriage between American Indian and Asian Indian respondents is extremely high in 1980 (slightly over 1) and diminishes dramatically in the ACS data (TODO: re-do this model to show that effect and test this effect on the separate ethnic groups in ACS. If still present in ACS time period, we should see substantially higher odds of Asian Indian/American Indian intermarriage than other groups' intermarriage with American Indians).

## Ethnic-Group Specific Exogamy

I now turn to models that estimate full ethnicity-by-ethnicity terms within the E&SE Asian and Latino categories. These terms will allow me to create heat maps with combined dendrograms that show the patterns of association between specific ethnic groups within these big race categories. 

The 15 E&SE Asian categories, 19 Latino categories, and 4 South Asian categories are unfeasible for an analysis for two reasons. First, the sample size of some of these groups is so small that I end up with sparse data and models that do not fully converge on parameters involving these groups. Even in cases, with convergence, the standard errors are so large that I cannot draw any conclusions with precision. Second, the number of parameters that I would need to estimate for these models is ridiculous (282 ethnic-by-ethnic terms in the fullest model) making the models impossible to actually fit. 

To determine what is feasible to fit, I used basic cutoffs on group size to eliminate groups from model estimation, until I produced models that fit well on all parameters with standard errors that give reasonable precision. This was an iterative process. 

For the E&SE Asian case, I ultimately was forced to use the same five groups as in the 1980 data:

* Chinese
* Korean
* Japanese
* Vietnamese
* Filipino

I hade hoped to also use the SE Asian groups of Thai, Hmong, and Cambodian, all of whom have similar sample sizes. However, the standard errors on these estimates were very large and a few of the parameters between these groups failed to converge.

For the Latino case, I was able to retain the nine largest groups of:

* Mexican
* Cuban
* Puerto Rican
* Dominican
* Salvadorian
* Guatemalan
* Colombian
* Ecuadorian
* Peruvian

This gives me a good sampling of Central American, Caribbean, and South American nationalities. It also gives me two groups (PR and Dominican) that are generally considered more afro-Latino than other groups (although Colombians and Cubans maybe as well?).

I also included specific variables for Black/Latino ethnicity and Black/Asian ethnicity rather than single Black/Latino and Black/Asian variables, respectively. This approach allows me to see whether the Black/non-Black divide works differently for some Latino and Asian ethnic groups. 

For South Asians, none of the groups outside of Asian Indians are large enough to sustain an analysis. TODO: Could I consider a crude "religion" split, Asian Indians vs. all others? Its not perfect because some Asian Indians will also be Muslim.

In addition to all of these parameters, I also include a Filipino/Latino dummy variable to capture particular affinities between Latinos and this "latinized" Asian ethnic group. 

```{r heat-map-function}
#function for ethnic heat maps
heatmap_ethnic <- function(groups, model_name, y=0.6, height=0.68) {
  or <- coefs_extended %>%
    filter(data=="ACS 2014-18, expanded ethnic groups" &
             model==model_name &
             grepl(paste(groups,collapse="|"), variable) &
             !grepl("Black", variable)) %>% #ugly hack, FIXME
    calc_or_matrix()
  hc <- hclust(as.dist(or))
  or <- or[hc$order, rev(hc$order)]
  
  gg.heat <- ggplot(melt(or, na.rm=TRUE), aes(Var2, Var1, fill = value))+
    geom_tile(color = NA)+
    scale_fill_gradient2(low = "#276419", high = "#8e0152", mid = "#f7f7f7", 
                         midpoint = 1, limit = c(0, max(or)),
                         name="odds ratio")+
    geom_text(aes(label=paste(round(or,2))))+
    labs(x=NULL, y=NULL,
         caption=paste("model:", model_name))+
    theme_minimal()+
    theme(legend.position = "left", 
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text.x = element_text(angle = 45, hjust = 1))
  
  dendro <- as.dendrogram(hc)
  gg.dendro <- ggdendrogram(data = dendro, rotate = TRUE, labels = FALSE)+theme_void()
  
  grid.newpage()
  print(gg.heat, vp = viewport(x = 0.4, y = 0.5, width = 0.8, height = 1.0))
  print(gg.dendro, vp = viewport(x = 0.9, y = y, width = 0.2, height = height))
}
```

### E&SE Asian Specific Ethnic Exogamy

I start by looking at heat maps of the odds ratio of endogamy when looking at specific combinations of ethnic groups. I also treat these odds ratios as distances in order to calculate dendrograms showing the closeness of each ethnic group. The figures below show both the heat map and dendrograms. I show the heat map for each of the four models to see how controlling for laanguage and birthplace endogamy affect the results.

```{r asian-heat-maps}
asian_groups <- c("Chinese","Korean","Japanese","Vietnamese","Filipino")
heatmap_ethnic(asian_groups, "Baseline")
heatmap_ethnic(asian_groups, "+ language endogamy")
heatmap_ethnic(asian_groups, "+ birthplace endogamy")
heatmap_ethnic(asian_groups, "+ both")
```

In general, here is my summary of what I see:

* Language and birthplace endogamy both reduce these odds ratios quite a bit although language endogamy plays a bigger role. 
* The biggest division is between Filipinos and all others. There remain significant boundaries with every other ethnic group included even after controlling for language and birth[place endogamy.
* Many of the final estimated odds ratios are actually less than 1! There is little evidence of any barriers at all between intermarriage of Chinese, Korean, and Japanese respondents, net of language endogamy. There is still moderate barriers between Korean/Japanese and Vietnamese, but not Chinese and Vietnamese, which actually had the lowest estimated odds ratios overall.


#### Changes over time

```{r asian-exog-change}
#TODO: why is Korean/Vietnamese missing in 1980 data?
#Vietnamese is not fitting well in most of these cases, so remove that group
coefs_extended %>%
  filter(grepl(paste(asian_groups,collapse="|"), variable) & 
           !grepl("Vietnamese", variable) & !grepl("Black", variable) & 
           model=="+ both" & 
           data!="ACS 2014-18, expanded ethnic groups") %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2)+
  geom_segment(data=subset(arrows_extended, 
                           grepl(paste(asian_groups,collapse="|"), variable) &
                             !grepl("Vietnamese", variable) & 
                             !grepl("Black", variable) ), 
               aes(x=variable, xend=variable, 
                   y=exp(coef.census), yend=exp(coef.acs)),
               arrow = arrow(length = unit(0.02, "npc")),
               color="grey60")+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="Changes in specific E&SE Asian ethnic exogamy over time",
       caption="Vietnamese excluded due to poor model fitting in Cenus 1980")+
  theme_bw()
```

The results here show increases in all cases of ethnic exogamy, although the largest increases are for the East Asian groups of Chinese, Japanese, and Korean. In every case of these latter groups, the estimated parameters have crossed the important threshold of one. 

### Latino Specific Ethnic Exogamy

I run the same heatmaps for Latino exogamy.

```{r latino-heat-maps}
latino_groups <- c("Mexican","Puerto Rican","Cuban","Guatemalan",
                   "Salvadorian","Colombian","Ecuadorian","Peruvian",
                   "Dominican")
heatmap_ethnic(latino_groups, "Baseline", height=0.75)
heatmap_ethnic(latino_groups, "+ language endogamy", height=0.75)
heatmap_ethnic(latino_groups, "+ birthplace endogamy", height=0.75)
heatmap_ethnic(latino_groups, "+ both", height=0.75)
```

With more groups, the results here are more complicated to interpret, but here is what I see:

* I see some evidence of regional divisions. The Central American/Mexican cases all group together. The South American and Caribbean cases also sort of group together, except for the case of Peruvian/Cuban. 
* The odds between Puerto Rican and Dominican are the second lowest and both of these groups are the "blackest" so there may be something there.
* In general the strongest boundaries overall are between Mexicans and other groups (thats eyeballing it, but I should check more thoroughly).

#### Changes over time

```{r latino-exog-change}
latino_groups1980 <- c("Mexican","Puerto Rican","Cuban")
coefs_extended %>%
  filter(grepl(paste(latino_groups1980,collapse="|"), variable) & 
           !grepl("Black", variable) & 
           model=="+ both" & 
           data!="ACS 2014-18, expanded ethnic groups") %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2)+
  geom_segment(data=subset(arrows_extended, 
                           grepl(paste(latino_groups1980,collapse="|"), variable) &
                             !grepl("Black", variable)), 
               aes(x=variable, xend=variable, 
                   y=exp(coef.census), yend=exp(coef.acs)),
               arrow = arrow(length = unit(0.02, "npc")),
               color="grey60")+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="Changes in specific Latino ethnic exogamy over time")+
  theme_bw()
```

There have been virtually no changes over time in specific latino ethnic exogamy among the three groups where we can track change.

### Black/Latino Ethnic Exogamy

```{r black-latino-exog}
coefs_extended %>%
  filter(grepl(paste(latino_groups,collapse="|"), variable) & 
           grepl("Black", variable) & 
           model=="+ both" & 
           data=="ACS 2014-18, expanded ethnic groups") %>%
  ggplot(aes(y=reorder(variable, coef, max), x=exp(coef)))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_x_continuous(limits=c(0,1))+
  labs(y=NULL, 
       x="Odds ratio of union formation for black and Latino partner relative to endogamy",
       title="Odds ratio of Black/Latino exogamy by Latino ethnic group")+
  theme_bw()+
  theme(legend.position = "right")
```

The results here are pretty telling. There are basically two groups, Puerto Ricans and Dominicans and everyone else. Puerto Ricans and Dominicans are significantly more likely to intermarry with Blacks than all of the other groups. So some evidence of different patterns for groups that are more Afro-Latino in make-up.

How do these odds compare to the odds of Latino ethnic exogamy for Puerto Ricans and Dominicans?

```{r puerto-rican-exog-lolly}
coefs_extended %>%
  filter(grepl("Puerto Rican", variable) & 
           model=="+ both" & 
           data=="ACS 2014-18, expanded ethnic groups") %>%
  mutate(black_intermar=grepl("Black", variable)) %>%
  ggplot(aes(y=reorder(variable, coef, max), x=exp(coef),
             color=black_intermar))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_x_continuous(limits=c(0,1))+
  scale_color_manual(values = c("black","red"))+
  labs(y=NULL, 
       x="Odds ratio of exogamy for Puerto Ricans relative to endogamy",
       title="Odds ratio of Puerto Rican exogamy")+
  theme_bw()+
  theme(legend.position = "none")
```

```{r dominican-exog-lolly}
coefs_extended %>%
  filter(grepl("Dominican", variable) & 
           model=="+ both" & 
           data=="ACS 2014-18, expanded ethnic groups") %>%
  mutate(black_intermar=grepl("Black", variable)) %>%
  ggplot(aes(y=reorder(variable, coef, max), x=exp(coef),
             color=black_intermar))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_x_continuous(limits=c(0,1))+
  scale_color_manual(values = c("black","red"))+
  labs(y=NULL, 
       x="Odds ratio of exogamy for Dominican relative to endogamy",
       title="Odds ratio of Dominican exogamy")+
  theme_bw()+
  theme(legend.position = "none")
```

The odds of outmarrying to a Black partner are still lower than exogamy to most other Latino ethnic groups although they are relatively comparable for many cases.

#### Changes over time

```{r black-latino-exog-change}
coefs_extended %>%
  filter(grepl(paste(latino_groups1980,collapse="|"), variable) & 
           grepl("Black", variable) & 
           model=="+ both" & 
           data!="ACS 2014-18, expanded ethnic groups") %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2)+
  geom_segment(data=subset(arrows_extended, 
                           grepl(paste(latino_groups1980,collapse="|"), variable) &
                             grepl("Black", variable)), 
               aes(x=variable, xend=variable, 
                   y=exp(coef.census), yend=exp(coef.acs)),
               arrow = arrow(length = unit(0.02, "npc")),
               color="grey60")+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="Changes in specific Latino/Black exogamy over time")+
  theme_bw()
```

In 1980, the odds for all three groups were very similar. Black/Puerto Rican intermarriage has increased substantially over time, in contrast to the other cases. Evidence of increasing racialization of Puerto Ricans (and probably Dominicans) as black over time.

### Black/Asian Ethnic Exogamy

```{r black-asian-exog}
coefs_extended %>%
  filter(grepl(paste(asian_groups,collapse="|"), variable) & 
           grepl("Black", variable) & 
           model=="+ both" & 
           data=="ACS 2014-18, expanded ethnic groups") %>%
  ggplot(aes(y=reorder(variable, coef, max), x=exp(coef)))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_x_continuous(limits=c(0,1))+
  labs(y=NULL, 
       x="Odds ratio of union formation for black and Latino partner relative to endogamy",
       title="Odds ratio of Black/Latino exogamy by Latino ethnic group")+
  theme_bw()+
  theme(legend.position = "right")
```

Not a lot going on here. Its very low for all groups and no particular groups standout.

#### Changes over time

```{r black-asian-exog-change}
coefs_extended %>%
  filter(grepl(paste(asian_groups,collapse="|"), variable) & 
           grepl("Black", variable) & 
           model=="+ both" & 
           data!="ACS 2014-18, expanded ethnic groups") %>%
  ggplot(aes(x=variable, y=exp(coef)))+
  geom_hline(yintercept = 1, linetype=2)+
  geom_point(aes(color=data), size=2)+
  geom_segment(data=subset(arrows_extended, 
                           grepl(paste(asian_groups,collapse="|"), variable) &
                             grepl("Black", variable)), 
               aes(x=variable, xend=variable, 
                   y=exp(coef.census), yend=exp(coef.acs)),
               arrow = arrow(length = unit(0.02, "npc")),
               color="grey60")+
  coord_flip()+
  scale_color_manual(values=my_palette)+
  labs(x=NULL, 
       y="odds ratio of union formation relative to racially endogamous union",
       color="data source",
       title="Changes in specific Latino/Black exogamy over time")+
  theme_bw()
```

Not a lot of change over time. The story is one of consistently low odds suggesting a very strong and persistent boundary between Asian ethnicities and Blackness.

### Filipino/Latino Exogamy


```{r}
#I need to grab this parameter from the original model summaries because it is not part of coefs_extended. Also, remember that this parameter is in addition to a general E&SE Asian/Latino parameter, so need to add them up to get the full effect.
latino_filipino_effect <- sapply(models_acsres_extended, function(x)
  {return(x$coef["race_filipino_latinoTRUE",1])})
latino_asian_effect <- sapply(models_acsres_extended, function(x)
  {return(x$coef["race_exog_extendedLatino.E&SE Asian",1])})
df_fili <- tibble(model=factor(rep(c("Baseline","+ birthplace endogamy",
                                     "+ language endogamy","+ both"),2),
                               levels=c("Baseline","+ birthplace endogamy",
                                     "+ language endogamy","+ both")),
       variable=rep(c("E&SE Asian/Latino","Filipino/Latino"), each=4),
       coef=c(latino_asian_effect,
              latino_asian_effect+latino_filipino_effect))

df_fili %>%
  ggplot(aes(y=model, x=exp(coef), color=variable))+
  geom_vline(xintercept = 0, color="grey70", linetype=1)+
  geom_vline(xintercept = 1, color="grey70", linetype=3)+
  geom_pointrangeh(aes(xmin=0, xmax=exp(coef)),
                   position=position_dodgev(height=0.5))+
  scale_color_manual(values=c("#7b3294","#008837","#a6dba0"))+
  scale_x_continuous(limits=c(0,1))+
  labs(y=NULL, 
       x="Odds ratio of exogamous union formation",
       color="Type of exogamy",
       title="Odds ratio of E&SE Asian/Latino exogamy in comparison to Filipino/Latino exogamy",
       caption="E&SE Asian/Latino exogamy is estimated exclusive of Filipinos")+
  theme_bw()+
  theme(legend.position = "right")
```

Filipino/Latino exogamy is considerably higher than E&SE Asian/Latino exogamy overall.

## Full Model Output

### Census 1980

```{r, results="asis"}
knitreg(lapply(models_census_pentagon, convertModel),
        digits=3,
        caption="Model predicting union formation on Census 1980 data using racial pentagon categories",
        caption.above=TRUE)
```

```{r, results="asis"}
knitreg(lapply(models_census_extended, convertModel),
        digits=3,
        caption="Model predicting union formation on Census 1980 data using specific Asian and Latino ethnic categories",
        caption.above=TRUE)
```

### ACS 2014-18

```{r, results="asis"}
knitreg(lapply(models_acs1980_pentagon, convertModel),
        digits=3,
        caption="Model predicting union formation on ACS 2014-18 data using racial pentagon categories and Asian/Latino ethnic groups available in 1980",
        caption.above=TRUE)
```

```{r, results="asis"}
knitreg(lapply(models_acs1980_extended, convertModel),
        digits=3,
        caption="Model predicting union formation on ACS 2014-18 data using specific Asian and Latino ethnic categories and Asian/Latino ethnic groups available in 1980",
        caption.above=TRUE)
```

```{r, results="asis"}
knitreg(lapply(models_acsfull_pentagon, convertModel),
        digits=3,
        caption="Model predicting union formation on ACS 2014-18 data using racial pentagon categories and all available Asian/Latino ethnic groups",
        caption.above=TRUE)
```

```{r, results="asis"}
knitreg(lapply(models_acsres_extended, convertModel),
        digits=3,
        caption="Model predicting union formation on ACS 2014-18 data using specific Asian and Latino ethnic categories and largest available Asian/Latino ethnic groups",
        caption.above=TRUE)
```